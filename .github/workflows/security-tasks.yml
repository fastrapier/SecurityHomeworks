name: Security Tasks CI

on:
  # Запуск при push в main ветку
  push:
    branches: [ main, master ]

  # Запуск при pull request
  pull_request:
    branches: [ main, master ]

  # Ручной запуск из GitHub UI
  workflow_dispatch:
    inputs:
      run_task_1:
        description: 'Запустить Task 1 (7z Bruteforce)'
        required: false
        default: true
        type: boolean
      run_task_2:
        description: 'Запустить Task 2 (SSH Medusa)'
        required: false
        default: true
        type: boolean

jobs:
  task-1-bruteforce:
    name: Task 1 - 7z Bruteforce (John The Ripper)
    runs-on: ubuntu-latest
    timeout-minutes: 15

    # Условие запуска: если это не workflow_dispatch или если выбрано в UI
    if: |
      github.event_name != 'workflow_dispatch' || 
      github.event.inputs.run_task_1 == 'true'

    steps:
      - name: Checkout репозитория
        uses: actions/checkout@v4

      - name: Информация о системе
        run: |
          echo "Runner OS: ${{ runner.os }}"
          echo "Docker version:"
          docker --version
          echo "Доступное место на диске:"
          df -h

      - name: Сборка Docker образа для Task 1
        working-directory: ./task_1_brutforce
        run: |
          echo "Сборка образа kali-bruteforce..."
          docker build -t kali-bruteforce .

      - name: Запуск брутфорса 7z архива
        working-directory: ./task_1_brutforce
        run: |
          echo "Запуск брутфорса (топ 10K паролей)..."
          docker run --rm -e WORDLIST_SIZE=10000 kali-bruteforce /task/bruteforce_turbo.sh || {
            echo "Пароль не найден в топ 10K, пробуем топ 50K..."
            docker run --rm -e WORDLIST_SIZE=50000 kali-bruteforce /task/bruteforce_turbo.sh || {
              echo "Пароль не найден. Для полного поиска запустите локально: make full"
            }
          }

      - name: Сохранение результатов Task 1
        if: always()
        working-directory: ./task_1_brutforce
        run: |
          echo "Сохранение результатов..."
          mkdir -p results
          
          CONTAINER_ID=$(docker create kali-bruteforce)
          docker cp $CONTAINER_ID:/task/flag.hash ./results/ 2>/dev/null || true
          docker cp $CONTAINER_ID:/task/flag.txt ./results/ 2>/dev/null || true
          docker cp $CONTAINER_ID:/root/.john/john.pot ./results/ 2>/dev/null || true
          docker rm $CONTAINER_ID 2>/dev/null || true
          
          echo "Результаты Task 1:"
          ls -la results/ 2>/dev/null || echo "Нет результатов"

      - name: Загрузка артефактов Task 1
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: task-1-results
          path: task_1_brutforce/results/
          if-no-files-found: warn

  task-2-medusa:
    name: Task 2 - SSH Bruteforce (Medusa)
    runs-on: ubuntu-latest
    timeout-minutes: 15

    # Условие запуска: если это не workflow_dispatch или если выбрано в UI
    if: |
      github.event_name != 'workflow_dispatch' || 
      github.event.inputs.run_task_2 == 'true'

    steps:
      - name: Checkout репозитория
        uses: actions/checkout@v4

      - name: Информация о системе
        run: |
          echo "Runner OS: ${{ runner.os }}"
          echo "Docker version:"
          docker --version
          echo "Доступное место на диске:"
          df -h

      - name: Сборка Docker образа для Task 2
        working-directory: ./task_2_medusa
        run: |
          echo "Сборка образа kali-medusa..."
          docker build -t kali-medusa .

      - name: Запуск брутфорса SSH с Medusa
        working-directory: ./task_2_medusa
        run: |
          echo "Запуск контейнера для брутфорса SSH..."
          CONTAINER_ID=$(docker run -d kali-medusa)
          echo "MEDUSA_CONTAINER_ID=$CONTAINER_ID" >> $GITHUB_ENV
          
          # Ждем завершения
          docker wait $CONTAINER_ID || true
          
          # Показываем логи
          echo "Логи контейнера:"
          docker logs $CONTAINER_ID

      - name: Извлечение результатов из контейнера
        if: always()
        working-directory: ./task_2_medusa
        run: |
          echo "Извлечение результатов..."
          mkdir -p results
          
          # Копируем результаты из сохраненного контейнера
          docker cp $MEDUSA_CONTAINER_ID:/task/medusa_output.txt ./results/ 2>/dev/null || echo "medusa_output.txt не найден"
          
          # Удаляем контейнер
          docker rm $MEDUSA_CONTAINER_ID 2>/dev/null || true
          
          echo ""
          echo "Результаты Task 2:"
          ls -la results/ || echo "Нет результатов"
          
          if [ -f results/medusa_output.txt ]; then
            echo ""
            echo "Содержимое medusa_output.txt:"
            cat results/medusa_output.txt
          fi

      - name: Загрузка артефактов Task 2
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: task-2-results
          path: task_2_medusa/results/
          if-no-files-found: warn

  summary:
    name: Итоговый отчет
    runs-on: ubuntu-latest
    needs: [task-1-bruteforce, task-2-medusa]
    if: always()

    steps:
      - name: Проверка результатов
        run: |
          echo "Сводка выполнения заданий:"
          echo ""
          echo "Task 1 (7z Bruteforce): ${{ needs.task-1-bruteforce.result }}"
          echo "Task 2 (SSH Medusa): ${{ needs.task-2-medusa.result }}"
          echo ""
          
          if [ "${{ needs.task-1-bruteforce.result }}" == "success" ] && [ "${{ needs.task-2-medusa.result }}" == "success" ]; then
            echo "Все задания выполнены успешно"
            exit 0
          elif [ "${{ needs.task-1-bruteforce.result }}" == "skipped" ] || [ "${{ needs.task-2-medusa.result }}" == "skipped" ]; then
            echo "Некоторые задания были пропущены"
            exit 0
          else
            echo "Некоторые задания завершились с ошибками"
            exit 1
          fi

