name: Security Tasks CI

on:
  # –ó–∞–ø—É—Å–∫ –ø—Ä–∏ push –≤ main –≤–µ—Ç–∫—É
  push:
    branches: [ main, master ]

  # –ó–∞–ø—É—Å–∫ –ø—Ä–∏ pull request
  pull_request:
    branches: [ main, master ]

  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –∏–∑ GitHub UI
  workflow_dispatch:
    inputs:
      run_task_1:
        description: '–ó–∞–ø—É—Å—Ç–∏—Ç—å Task 1 (7z Bruteforce)'
        required: false
        default: true
        type: boolean
      run_task_2:
        description: '–ó–∞–ø—É—Å—Ç–∏—Ç—å Task 2 (SSH Medusa)'
        required: false
        default: true
        type: boolean

jobs:
  task-1-bruteforce:
    name: Task 1 - 7z Bruteforce (John The Ripper)
    runs-on: ubuntu-latest
    timeout-minutes: 15

    # –£—Å–ª–æ–≤–∏–µ –∑–∞–ø—É—Å–∫–∞: –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ workflow_dispatch –∏–ª–∏ –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–æ –≤ UI
    if: |
      github.event_name != 'workflow_dispatch' || 
      github.event.inputs.run_task_1 == 'true'

    steps:
      - name: Checkout —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v4

      - name: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∏—Å—Ç–µ–º–µ
        run: |
          echo "üñ•Ô∏è Runner OS: ${{ runner.os }}"
          echo "üì¶ Docker version:"
          docker --version
          echo "üíæ –î–æ—Å—Ç—É–ø–Ω–æ–µ –º–µ—Å—Ç–æ –Ω–∞ –¥–∏—Å–∫–µ:"
          df -h

      - name: –°–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–∞ –¥–ª—è Task 1
        working-directory: ./task_1_brutforce
        run: |
          echo "üî® –°–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–∞ kali-bruteforce..."
          docker build -t kali-bruteforce .

      - name: –ó–∞–ø—É—Å–∫ –±—Ä—É—Ç—Ñ–æ—Ä—Å–∞ 7z –∞—Ä—Ö–∏–≤–∞
        working-directory: ./task_1_brutforce
        run: |
          echo "üöÄ –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –¥–ª—è –±—Ä—É—Ç—Ñ–æ—Ä—Å–∞..."
          echo "–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–∏—Ä–∞–µ–º –º–µ—Ç–æ–¥ 2 (rockyou.txt)"
          echo "2" | docker run -i --rm kali-bruteforce || {
            echo "‚ö†Ô∏è –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π, –Ω–æ —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–æ—Ä–º–∞–ª—å–Ω–æ"
            echo "–ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤..."
          }

      - name: –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
        if: always()
        working-directory: ./task_1_brutforce
        run: |
          echo "üìä –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤..."
          
          # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
          mkdir -p results
          
          # –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –≤—ã–±–æ—Ä–æ–º –º–µ—Ç–æ–¥–∞ –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –µ–≥–æ ID
          echo "–ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤..."
          CONTAINER_ID=$(echo "2" | docker run -i -d kali-bruteforce)
          
          # –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
          sleep 5
          
          # –ö–æ–ø–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
          docker cp $CONTAINER_ID:/task/flag.hash ./results/ 2>/dev/null || echo "‚ö†Ô∏è flag.hash –Ω–µ –Ω–∞–π–¥–µ–Ω"
          docker cp $CONTAINER_ID:/task/flag.txt ./results/ 2>/dev/null || echo "‚ö†Ô∏è flag.txt –Ω–µ –Ω–∞–π–¥–µ–Ω"
          
          # –ü–æ–ª—É—á–∞–µ–º –ª–æ–≥–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
          docker logs $CONTAINER_ID > ./results/container_output.log 2>&1 || echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ª–æ–≥–∏"
          
          # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏ —É–¥–∞–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
          docker stop $CONTAINER_ID 2>/dev/null || true
          docker rm $CONTAINER_ID 2>/dev/null || true
          
          echo ""
          echo "üìÅ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã Task 1:"
          ls -la results/ || echo "–ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤"
          
          if [ -f results/flag.txt ]; then
            echo ""
            echo "üìÑ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ flag.txt:"
            cat results/flag.txt
          fi

      - name: –ó–∞–≥—Ä—É–∑–∫–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ Task 1
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: task-1-results
          path: task_1_brutforce/results/
          if-no-files-found: warn

  task-2-medusa:
    name: Task 2 - SSH Bruteforce (Medusa)
    runs-on: ubuntu-latest
    timeout-minutes: 15

    # –£—Å–ª–æ–≤–∏–µ –∑–∞–ø—É—Å–∫–∞: –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ workflow_dispatch –∏–ª–∏ –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–æ –≤ UI
    if: |
      github.event_name != 'workflow_dispatch' || 
      github.event.inputs.run_task_2 == 'true'

    steps:
      - name: Checkout —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v4

      - name: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∏—Å—Ç–µ–º–µ
        run: |
          echo "üñ•Ô∏è Runner OS: ${{ runner.os }}"
          echo "üì¶ Docker version:"
          docker --version
          echo "üíæ –î–æ—Å—Ç—É–ø–Ω–æ–µ –º–µ—Å—Ç–æ –Ω–∞ –¥–∏—Å–∫–µ:"
          df -h

      - name: –°–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–∞ –¥–ª—è Task 2
        working-directory: ./task_2_medusa
        run: |
          echo "üî® –°–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–∞ kali-medusa..."
          docker build -t kali-medusa .

      - name: –ó–∞–ø—É—Å–∫ –±—Ä—É—Ç—Ñ–æ—Ä—Å–∞ SSH —Å Medusa
        working-directory: ./task_2_medusa
        run: |
          echo "üöÄ –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –¥–ª—è –±—Ä—É—Ç—Ñ–æ—Ä—Å–∞ SSH..."
          docker run --rm kali-medusa

      - name: –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
        if: always()
        working-directory: ./task_2_medusa
        run: |
          echo "üìä –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤..."
          
          # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
          mkdir -p results
          
          # –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏ –∫–æ–ø–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
          CONTAINER_ID=$(docker create kali-medusa)
          docker cp $CONTAINER_ID:/task/medusa_output.txt ./results/ 2>/dev/null || echo "‚ö†Ô∏è medusa_output.txt –Ω–µ –Ω–∞–π–¥–µ–Ω"
          docker rm $CONTAINER_ID
          
          echo ""
          echo "üìÅ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã Task 2:"
          ls -la results/ || echo "–ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤"
          
          if [ -f results/medusa_output.txt ]; then
            echo ""
            echo "üìÑ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ medusa_output.txt:"
            cat results/medusa_output.txt
          fi

      - name: –ó–∞–≥—Ä—É–∑–∫–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ Task 2
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: task-2-results
          path: task_2_medusa/results/
          if-no-files-found: warn

  summary:
    name: –ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç
    runs-on: ubuntu-latest
    needs: [task-1-bruteforce, task-2-medusa]
    if: always()

    steps:
      - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        run: |
          echo "üìä –°–≤–æ–¥–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∏–π:"
          echo ""
          echo "Task 1 (7z Bruteforce): ${{ needs.task-1-bruteforce.result }}"
          echo "Task 2 (SSH Medusa): ${{ needs.task-2-medusa.result }}"
          echo ""
          
          if [ "${{ needs.task-1-bruteforce.result }}" == "success" ] && [ "${{ needs.task-2-medusa.result }}" == "success" ]; then
            echo "‚úÖ –í—Å–µ –∑–∞–¥–∞–Ω–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!"
            exit 0
          elif [ "${{ needs.task-1-bruteforce.result }}" == "skipped" ] || [ "${{ needs.task-2-medusa.result }}" == "skipped" ]; then
            echo "‚è≠Ô∏è –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –∑–∞–¥–∞–Ω–∏—è –±—ã–ª–∏ –ø—Ä–æ–ø—É—â–µ–Ω—ã"
            exit 0
          else
            echo "‚ùå –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –∑–∞–¥–∞–Ω–∏—è –∑–∞–≤–µ—Ä—à–∏–ª–∏—Å—å —Å –æ—à–∏–±–∫–∞–º–∏"
            exit 1
          fi

