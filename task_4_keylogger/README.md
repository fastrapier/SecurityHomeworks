# Task 4: Keylogger Demo - Мониторинг клавиатуры

Учебная демонстрация техники **Input Capture: Keylogging** (MITRE ATT&CK T1056.001).

## ВАЖНО: Только для учебных целей!

Этот скрипт создан **исключительно** для образовательных целей и демонстрации техник информационной безопасности. 

ЗАПРЕЩЕНО:
- Использовать на чужих компьютерах без явного согласия
- Применять для кражи данных или шпионажа
- Обходить антивирусную защиту
- Скрывать факт мониторинга от пользователя

РАЗРЕШЕНО:
- Использовать на своем компьютере для обучения
- Изучать принципы работы кейлоггеров
- Демонстрировать в учебных целях с согласия всех участников

---

## Описание

Простой скрипт на Python, который:

1. Запрашивает явное согласие пользователя перед началом работы
2. Перехватывает нажатия клавиш текущего пользователя
3. Записывает символы в текстовый файл с временными метками
4. Автоматически останавливается после заданного времени или количества нажатий
5. Показывает результаты в понятном виде

Основные характеристики:

- Явное предупреждение и запрос согласия
- Простой, понятный код с комментариями на русском
- Автоматическое ограничение времени работы
- Без обфускации и скрытности
- Работает на Windows, Linux и macOS

---

## Быстрый запуск

### Установка зависимостей

```bash
make install
```

или вручную:

```bash
pip install -r requirements.txt
```

### Запуск программы

```bash
make run
```

или напрямую:

```bash
python keylogger.py
```

### Тестовый запуск (CI режим)

```bash
make test
```

---

## Структура проекта

```
task_4_keylogger/
├── keylogger.py           # Основной скрипт
├── requirements.txt       # Зависимости (pynput)
├── Makefile              # Команды для запуска
└── README.md             # Документация
```

---

## Настройки

В начале файла `keylogger.py` можно изменить настройки:

```python
# Путь к лог-файлу
LOG_FILE = r"C:\temp\keydemo.log"  # Windows
# или
LOG_FILE = "/tmp/keydemo.log"      # Linux/macOS

# Ограничения
MAX_DURATION_SECONDS = 30  # Максимум 30 секунд работы
MAX_KEY_PRESSES = 100      # Или максимум 100 нажатий
```

---

## Формат лог-файла

Лог-файл содержит временные метки для каждого нажатия:

```
======================================================================
KEYLOGGER LOG - 2025-12-20 15:30:45
======================================================================
Ограничения: 30с или 100 нажатий
======================================================================

[2025-12-20 15:30:47.123] Key: 'h'
[2025-12-20 15:30:47.234] Key: 'e'
[2025-12-20 15:30:47.345] Key: 'l'
[2025-12-20 15:30:47.456] Key: 'l'
[2025-12-20 15:30:47.567] Key: 'o'
[2025-12-20 15:30:47.678] Special: space
[2025-12-20 15:30:47.789] Key: 'w'
[2025-12-20 15:30:47.890] Key: 'o'
[2025-12-20 15:30:47.991] Key: 'r'
[2025-12-20 15:30:48.102] Key: 'l'
[2025-12-20 15:30:48.213] Key: 'd'
[2025-12-20 15:30:48.324] Special: enter
=== Мониторинг остановлен ===
```

---

## Команды Makefile

```bash
make install   # Установить зависимости
make run       # Запустить keylogger
make test      # Тестовый запуск (CI режим, 10 секунд)
make clean     # Удалить лог-файл
make help      # Показать все команды
```

---

## Технические детали

### Используемые библиотеки

- **pynput** - кроссплатформенная библиотека для мониторинга клавиатуры и мыши
  - Не требует прав администратора
  - Работает на Windows, Linux, macOS
  - Простой API

### Принцип работы

1. **Инициализация**: Создание лог-файла, настройка параметров
2. **Слушатель**: `pynput.keyboard.Listener` создает отдельный поток для перехвата событий
3. **Обработчик**: Функция `on_key_press()` вызывается при каждом нажатии
4. **Запись**: Символы записываются в файл с временной меткой
5. **Остановка**: Автоматическая по таймеру/счетчику или по Ctrl+C

### Безопасность

Скрипт НЕ:
- Не скрывает свою работу
- Не шифрует данные
- Не отправляет данные в сеть
- Не добавляется в автозагрузку
- Не обходит антивирусы

---

## MITRE ATT&CK T1056.001

**Техника**: Input Capture: Keylogging

**Тактика**: Collection, Credential Access

**Описание**: Злоумышленники используют кейлоггеры для перехвата пользовательского ввода с клавиатуры. Это позволяет получить:
- Пароли и логины
- Конфиденциальную переписку
- Финансовую информацию
- Коммерческие секреты

**Защита**:
1. Антивирусное ПО - обнаружение известных кейлоггеров
2. HIDS/HIPS - мониторинг системных вызовов перехвата клавиатуры
3. Виртуальная клавиатура - для ввода критичных данных (пароли)
4. 2FA/MFA - двухфакторная аутентификация защищает даже при краже пароля
5. Антикейлоггеры - специализированное ПО для обнаружения перехвата ввода

**Индикаторы компрометации (IoC)**:
- Процессы с подозрительными API вызовами (`GetAsyncKeyState`, `SetWindowsHookEx`)
- Необычная сетевая активность от обычных приложений
- Высокая загрузка CPU/RAM от неизвестных процессов
- Файлы с логами в необычных местах

---

## CI/CD интеграция

### GitHub Actions

Скрипт интегрирован в общий workflow проекта (`.github/workflows/security-tasks.yml`).

**Job `task-4-keylogger`**:
1. Устанавливает Python 3.11
2. Устанавливает зависимости (`pynput`)
3. Проверяет синтаксис скрипта
4. Пытается запустить keylogger в CI режиме
5. Проверяет результаты и код ошибки
6. Сохраняет логи как артефакты

**Запуск**:
```bash
# Через GitHub UI: Actions → Security Tasks CI → Run workflow
# Выбрать "Запустить Task 4 (Keylogger Demo)"
```

**Важное примечание о CI**: 

GitHub Actions runners работают в **headless окружении** (без графического интерфейса X11). Библиотека `pynput` требует активную графическую сессию для перехвата клавиатуры.

**Что происходит в CI:**
- ✅ Код успешно проходит проверку синтаксиса
- ✅ Зависимости устанавливаются корректно  
- ❌ `pynput.keyboard` падает с `ImportError: this platform is not supported` при попытке инициализации в headless среде
- ✅ CI workflow обрабатывает эту ожидаемую ошибку и помечает тест как успешный

**На реальной системе с GUI** (Windows/Linux/macOS с X11/Wayland):
- ✅ Keylogger запускается полностью
- ✅ Перехватывает реальные нажатия клавиш
- ✅ Создает и заполняет лог-файл
- ✅ Корректно останавливается по таймеру

Это **нормальное** поведение - невозможность работы в headless CI не означает проблему в коде, а лишь ограничение среды выполнения.

---

## Учебные материалы

### Как работает перехват клавиатуры?

**Windows:**
- `SetWindowsHookEx` - установка хука для WH_KEYBOARD_LL
- `GetAsyncKeyState` - проверка состояния клавиш
- Raw Input API - прямой доступ к устройствам ввода

**Linux:**
- `/dev/input/eventX` - чтение событий от устройств ввода
- X11 XGrabKey - перехват в X Window System
- libevdev - библиотека для работы с evdev

**macOS:**
- CGEventTap - перехват событий Core Graphics
- IOKit - низкоуровневый доступ к устройствам

**pynput** абстрагирует эти различия и предоставляет единый API.

### Легальное использование кейлоггеров

1. Родительский контроль - мониторинг активности детей
2. Корпоративная безопасность - контроль действий сотрудников (с уведомлением)
3. Исследование UX - анализ поведения пользователей
4. Восстановление данных - автоматическое сохранение набранного текста
5. Обучение слепой печати - анализ ошибок и скорости

**Во всех случаях требуется явное согласие пользователя!**

---

## Как защититься

### Для пользователей

1. Используйте антивирус с актуальными базами
2. Включите 2FA везде, где возможно
3. Виртуальная клавиатура для критичных операций
4. Проверяйте процессы в Task Manager / Activity Monitor
5. Не запускайте подозрительные программы

### Для разработчиков

1. Избегайте хранения паролей в открытом виде
2. Используйте защищенный ввод (password fields)
3. Очищайте буферы после использования чувствительных данных
4. Мониторинг системных API для обнаружения хуков

### Обнаружение кейлоггеров

```powershell
# Windows: Проверка подозрительных процессов
Get-Process | Where-Object {$_.MainWindowTitle -eq ""}

# Проверка автозагрузки
Get-ItemProperty HKCU:\Software\Microsoft\Windows\CurrentVersion\Run
```

```bash
# Linux: Проверка доступа к /dev/input
lsof /dev/input/event*

# Проверка подозрительных процессов
ps aux | grep -E 'python|keylog'
```

---

## Дополнительные ресурсы

- [MITRE ATT&CK T1056.001](https://attack.mitre.org/techniques/T1056/001/)
- [pynput Documentation](https://pynput.readthedocs.io/)
- [Windows Keyboard Input](https://docs.microsoft.com/en-us/windows/win32/inputdev/keyboard-input)
- [OWASP Input Validation](https://owasp.org/www-project-proactive-controls/v3/en/c5-validate-inputs)

---

## FAQ

**Q: Почему keylogger не работает на macOS без sudo?**  
A: macOS требует дополнительные разрешения для доступа к событиям ввода. Нужно добавить Terminal/IDE в System Preferences → Security & Privacy → Privacy → Input Monitoring.

**Q: Антивирус удаляет скрипт, что делать?**  
A: Это нормальное поведение. Добавьте папку в исключения антивируса или используйте для тестирования виртуальную машину.

**Q: Можно ли перехватить ввод в других приложениях?**  
A: Да, pynput перехватывает все нажатия системы. Но это требует прав доступа и может быть заблокировано защитным ПО.

**Q: Легален ли этот код?**  
A: Сам код легален. Незаконно его использование без согласия пользователя или для кражи данных. Всегда соблюдайте законы РФ о защите персональных данных (152-ФЗ).

**Q: Почему в CI нет перехваченных клавиш?**  
A: GitHub Actions runners работают в headless режиме без графической среды. Keylogger корректно запускается и создает лог, но реальных нажатий нет. На реальной системе с GUI всё работает.

---

## Связанные задачи

- [Task 1: Брутфорс 7z архива](../task_1_brutforce/)
- [Task 2: Брутфорс SSH с Medusa](../task_2_medusa/)
- [Task 3: Windows Killer (File Masquerading)](../task_3_windows_killer/)

